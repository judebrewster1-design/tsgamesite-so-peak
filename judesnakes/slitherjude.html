<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slither Arena</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Orbitron', sans-serif;
            background: radial-gradient(circle at 50% 50%, #1a0033, #000000);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }
        
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            z-index: 2000;
        }
        
        #auth-screen {
            background: radial-gradient(circle at 50% 50%, #2d1b4e, #0a0015);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .auth-container {
            background: linear-gradient(145deg, #1a0033, #0a001a);
            border: 4px solid #00ff88;
            padding: 40px;
            border-radius: 25px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,255,136,0.5);
        }
        
        .auth-container h1 {
            font-size: 2.8em;
            color: #00ff88;
            text-shadow: 0 0 20px #00ff88;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .auth-container .warning {
            color: #ffaa00;
            font-size: 0.85em;
            text-align: center;
            margin-bottom: 25px;
            opacity: 0.9;
        }
        
        .auth-container input {
            width: 100%;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #00ff88;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 16px;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
        }
        
        .auth-container button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(145deg, #00ff88, #00cc66);
            color: #000;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,255,136,0.5);
            margin-bottom: 10px;
        }
        
        .auth-container button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,255,136,0.8);
        }
        
        .register-link {
            text-align: center;
            color: #00ffff;
            cursor: pointer;
            margin-top: 15px;
            font-size: 0.9em;
            padding: 10px;
        }
        
        .register-link:hover {
            text-decoration: underline;
        }
        
        #control-select {
            background: radial-gradient(circle at 50% 50%, #2d1b4e, #0a0015);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 30px 20px;
        }
        
        #control-select h1 {
            font-size: 3em;
            color: #00ff88;
            text-shadow: 0 0 20px #00ff88;
            margin-bottom: 20px;
        }
        
        .control-options {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-card {
            background: linear-gradient(145deg, #2a1a4d, #1a0a3d);
            border: 3px solid #00ff88;
            border-radius: 20px;
            padding: 30px;
            width: 280px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,255,136,0.3);
        }
        
        .control-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 50px rgba(0,255,136,0.6);
        }
        
        .control-card .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        .control-card h3 {
            font-size: 1.6em;
            color: #00ff88;
            margin-bottom: 12px;
        }
        
        #main-menu {
            background: radial-gradient(circle at 50% 50%, #2d1b4e, #0a0015);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .menu-container {
            background: linear-gradient(145deg, #1a0033, #0a001a);
            border: 4px solid #00ff88;
            padding: 40px;
            border-radius: 25px;
            max-width: 600px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,255,136,0.5);
        }
        
        .menu-container h1 {
            font-size: 3em;
            color: #00ff88;
            text-shadow: 0 0 20px #00ff88;
            margin-bottom: 30px;
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .menu-btn {
            padding: 20px;
            background: linear-gradient(145deg, #00ff88, #00cc66);
            color: #000;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 20px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,255,136,0.5);
        }
        
        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,255,136,0.8);
        }
        
        .menu-btn.shop {
            background: linear-gradient(145deg, #ff00ff, #cc00cc);
            box-shadow: 0 5px 20px rgba(255,0,255,0.5);
        }
        
        .leaderboard {
            background: rgba(0,0,0,0.5);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .leaderboard h2 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.8em;
        }
        
        .leader-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0,255,136,0.1);
            border-radius: 10px;
            color: #fff;
        }
        
        .leader-item.top1 { border: 2px solid gold; }
        .leader-item.top2 { border: 2px solid silver; }
        .leader-item.top3 { border: 2px solid #cd7f32; }
        
        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: none;
        }
        
        #game {
            display: block;
            background: #000;
        }
        
        .hud-panel {
            position: fixed;
            background: rgba(10, 0, 30, 0.9);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,255,136,0.4);
        }
        
        #main-hud {
            top: 10px;
            left: 10px;
            min-width: 180px;
            font-size: 12px;
        }
        
        #main-hud .stat {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            color: #fff;
        }
        
        #player-list {
            top: 10px;
            right: 180px;
            min-width: 150px;
            max-height: 225px;
            overflow-y: auto;
            font-size: 11px;
        }
        
        #player-list h3 {
            color: #00ff88;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,255,136,0.2);
            color: #fff;
        }
        
        #minimap {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 140px;
            height: 93px;
            border: 3px solid #00ff88;
            border-radius: 15px;
            background: rgba(0,0,0,0.8);
            box-shadow: 0 5px 20px rgba(0,255,136,0.4);
        }
        
        #sprint-btn {
            position: fixed;
            bottom: 170px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 100px;
            background: linear-gradient(145deg, #ffaa00, #ff8800);
            color: #fff;
            border: 4px solid #ffaa00;
            border-radius: 50%;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 16px;
            box-shadow: 0 5px 20px rgba(255,170,0,0.5);
            display: none;
            z-index: 100;
        }
        
        #sprint-btn:active {
            transform: translateX(-50%) scale(0.95);
            box-shadow: 0 3px 15px rgba(255,170,0,0.7);
        }
        
        #chat-box {
            position: fixed;
            bottom: 10px;
            left: 10px;
            width: 350px;
            max-height: 200px;
            background: rgba(10, 0, 30, 0.95);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 12px;
            display: none;
        }
        
        #chat-messages {
            height: 120px;
            overflow-y: auto;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .chat-msg {
            color: #fff;
            margin: 4px 0;
        }
        
        .chat-msg .user {
            color: #00ff88;
            font-weight: 700;
        }
        
        #chat-input {
            flex: 1;
            padding: 8px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #00ff88;
            border-radius: 8px;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
        }
        
        #chat-send {
            padding: 8px 16px;
            background: #00ff88;
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 12px;
        }
        
        #chat-toggle {
            position: fixed;
            bottom: 220px;
            left: 10px;
            padding: 12px 20px;
            background: rgba(0,255,136,0.9);
            color: #000;
            border: 2px solid #00ff88;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            display: none;
            font-size: 13px;
        }
        
        #death-screen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #1a0033, #0a001a);
            border: 5px solid #ff0055;
            padding: 50px;
            border-radius: 25px;
            text-align: center;
            z-index: 3000;
            display: none;
            box-shadow: 0 20px 60px rgba(255,0,85,0.6);
            min-width: 400px;
        }
        
        #death-screen h2 {
            color: #ff0055;
            font-size: 3.5em;
            margin-bottom: 25px;
            text-shadow: 0 0 20px #ff0055;
        }
        
        #death-screen .stat-line {
            font-size: 1.3em;
            margin: 12px 0;
            color: #fff;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        #death-screen .stat-line .label {
            color: #00ff88;
        }
        
        #death-screen .stat-line .value {
            color: #00ffff;
            font-weight: 900;
        }
        
        #death-screen .death-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        #death-screen button {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        #respawn-btn {
            background: linear-gradient(145deg, #00ff88, #00cc66);
            color: #000;
            box-shadow: 0 5px 20px rgba(0,255,136,0.5);
        }
        
        #respawn-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,255,136,0.8);
        }
        
        #menu-btn {
            background: linear-gradient(145deg, #0099ff, #0066cc);
            color: #fff;
            box-shadow: 0 5px 20px rgba(0,153,255,0.5);
        }
        
        #menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,153,255,0.8);
        }
        
        #shop-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #1a0033, #0a001a);
            border: 4px solid #ff00ff;
            padding: 30px;
            border-radius: 25px;
            max-width: 90vw;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 3000;
            display: none;
            box-shadow: 0 20px 60px rgba(255,0,255,0.5);
        }
        
        #shop-panel h2 {
            color: #ff00ff;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .shop-info {
            text-align: center;
            color: #00ffff;
            margin-bottom: 20px;
            font-size: 1.2em;
        }
        
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .skin-card {
            background: linear-gradient(145deg, #2a1a4d, #1a0a3d);
            border: 3px solid #ff00ff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .skin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255,0,255,0.5);
        }
        
        .skin-card.owned {
            border-color: #00ff88;
        }
        
        .skin-card.selected {
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0,255,255,0.6);
        }
        
        .skin-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 3px solid #00ff88;
            background: #000;
            overflow: hidden;
        }
        
        .skin-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .skin-card h4 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .skin-card button {
            padding: 10px 20px;
            background: linear-gradient(145deg, #00ff88, #00cc66);
            color: #000;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 13px;
            margin: 4px;
            transition: all 0.3s;
        }
        
        .skin-card button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        .skin-card button:disabled {
            background: linear-gradient(145deg, #555, #333);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .skin-card button.select {
            background: linear-gradient(145deg, #00ffff, #00cccc);
        }
        
        #close-shop {
            width: 100%;
            padding: 15px;
            background: linear-gradient(145deg, #ff0055, #cc0044);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 16px;
            margin-top: 20px;
        }
        
        #mobile-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
        }
        
        .joystick {
            width: 130px;
            height: 130px;
            background: rgba(0,255,136,0.3);
            border: 3px solid #00ff88;
            border-radius: 50%;
            position: relative;
        }
        
        .joystick-handle {
            width: 55px;
            height: 55px;
            background: #00ff88;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        @media (max-width: 768px) {
            .auth-container {
                padding: 25px;
            }
            
            .auth-container h1 {
                font-size: 2.2em;
            }
            
            #main-hud {
                padding: 6px 8px;
                min-width: 140px;
                font-size: 9px;
            }
            
            #player-list {
                right: 120px;
                min-width: 120px;
                max-height: 170px;
                padding: 10px;
                font-size: 9px;
            }
            
            #minimap {
                width: 105px;
                height: 70px;
            }
            
            #chat-box {
                width: calc(100vw - 20px);
                max-height: 180px;
            }
            
            .menu-container {
                padding: 25px;
            }
            
            .menu-container h1 {
                font-size: 2.2em;
            }
            
            #death-screen {
                min-width: 90vw;
                padding: 30px 20px;
            }
            
            #death-screen h2 {
                font-size: 2.5em;
            }
            
            .skin-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 15px;
            }
            
            #sprint-btn {
                display: block;
            }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="auth-screen" class="screen" style="display: flex;">
        <div class="auth-container">
            <h1>SLITHER ARENA</h1>
            <p class="warning">⚠️ Do NOT use your email or Google login!</p>
            <input type="text" id="auth-username" placeholder="Username" maxlength="20" />
            <input type="password" id="auth-password" placeholder="Password" maxlength="50" />
            <button id="login-btn">LOGIN</button>
            <div class="register-link" id="register-link">Create New Account</div>
            <p id="auth-status" style="color: #ffaa00; text-align: center; margin-top: 15px;"></p>
        </div>
    </div>
    
    <div id="control-select" class="screen">
        <h1>CHOOSE CONTROLS</h1>
        <div class="control-options">
            <div class="control-card" data-mode="wasd">
                <div class="icon">⌨️</div>
                <h3>WASD</h3>
                <p>Keyboard controls<br>SHIFT to sprint</p>
            </div>
            <div class="control-card" data-mode="cursor">
                <div class="icon">🖱️</div>
                <h3>CURSOR</h3>
                <p>Follow mouse<br>SHIFT to sprint</p>
            </div>
            <div class="control-card" data-mode="mobile">
                <div class="icon">📱</div>
                <h3>MOBILE</h3>
                <p>Touch joystick<br>Sprint button</p>
            </div>
        </div>
    </div>
    
    <div id="main-menu" class="screen">
        <div class="menu-container">
            <h1>MAIN MENU</h1>
            <div class="menu-buttons">
                <button class="menu-btn" id="play-btn">PLAY</button>
                <button class="menu-btn shop" id="menu-shop-btn">SHOP</button>
                <button class="menu-btn" id="logout-btn">LOGOUT</button>
            </div>
            <div class="leaderboard">
                <h2>TOP 10 PLAYERS</h2>
                <div id="leaderboard-list"></div>
            </div>
        </div>
    </div>
    
    <div id="game-container">
        <canvas id="game"></canvas>
        
        <div id="main-hud" class="hud-panel">
            <div class="stat"><span>SCORE</span><span id="score">0</span></div>
            <div class="stat"><span>POINTS</span><span id="points">0</span></div>
            <div class="stat"><span>HIGH</span><span id="highscore">0</span></div>
        </div>
        
        <div id="player-list" class="hud-panel">
            <h3>PLAYERS</h3>
            <div id="players-container"></div>
        </div>
        
        <canvas id="minimap"></canvas>
        
        <button id="chat-toggle">CHAT</button>
        <div id="chat-box">
            <div id="chat-messages"></div>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="chat-input" placeholder="Message..." maxlength="200" />
                <button id="chat-send">SEND</button>
            </div>
        </div>
        
        <button id="sprint-btn">SPRINT</button>
        
        <div id="death-screen">
            <h2>ELIMINATED</h2>
            <div class="stat-line"><span class="label">SCORE:</span> <span class="value" id="death-score">0</span></div>
            <div class="stat-line"><span class="label">EARNED:</span> <span class="value" id="death-points">0</span></div>
            <div class="stat-line"><span class="label">TOTAL:</span> <span class="value" id="death-total">0</span></div>
            <div class="stat-line"><span class="label">BEST:</span> <span class="value" id="death-high">0</span></div>
            <div class="death-buttons">
                <button id="respawn-btn">RESPAWN</button>
                <button id="menu-btn">MAIN MENU</button>
            </div>
        </div>
        
        <div id="mobile-controls">
            <div class="joystick" id="joystick">
                <div class="joystick-handle" id="joystick-handle"></div>
            </div>
        </div>
    </div>
    
    <div id="shop-panel">
        <h2>SKIN SHOP</h2>
        <div class="shop-info">Your Points: <span id="shop-points">0</span></div>
        <div class="skin-grid" id="skins-grid"></div>
        <button id="close-shop">CLOSE</button>
    </div>
    
    <script>
        const WORLD_WIDTH = 3000;
        const WORLD_HEIGHT = 2000;
        const WS_URL = 'wss://perfectly-vegas-rolling-conf.trycloudflare.com';
        
        let controlMode = null;
        let ws = null;
        let playerId = null;
        let gameState = { snakes: {}, balls: [] };
        let playerData = { points: 0, highScore: 0, ownedSkins: ['jude'] };
        let camera = { x: 0, y: 0 };
        let direction = { x: 1, y: 0 };
        let isDead = false;
        let currentUsername = '';
        let currentPassword = '';
        let currentSkinId = 'jude';
        let chatUnlocked = false;
        let mouseX = 0, mouseY = 0;
        let joystickActive = false;
        let skins = [];
        let skinImages = {};
        let lastInputTime = 0;
        let gameLoopRunning = false;
        let isSprinting = false;
        let keys = {};
        
        document.getElementById('login-btn').addEventListener('click', () => handleAuth(false));
        document.getElementById('register-link').addEventListener('click', () => handleAuth(true));
        document.getElementById('auth-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAuth(false);
        });
        
        async function handleAuth(isRegister) {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            const status = document.getElementById('auth-status');
            
            if (!username || !password) {
                status.textContent = 'Enter username and password';
                return;
            }
            
            if (username.length < 3) {
                status.textContent = 'Username must be 3+ characters';
                return;
            }
            
            currentUsername = username;
            currentPassword = password;
            
            status.textContent = isRegister ? 'Creating account...' : 'Logging in...';
            connectForAuth(isRegister);
        }
        
        function connectForAuth(isRegister) {
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                ws.send(JSON.stringify({
                    type: isRegister ? 'register' : 'login',
                    username: currentUsername,
                    password: currentPassword
                }));
            };
            
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                
                if (msg.type === 'authSuccess') {
                    playerData = msg.playerData;
                    currentSkinId = msg.currentSkin || 'jude';
                    skins = msg.skins || [];
                    loadSkinImages();
                    showScreen('control-select');
                } else if (msg.type === 'authError') {
                    document.getElementById('auth-status').textContent = msg.message;
                }
            };
            
            ws.onerror = () => {
                document.getElementById('auth-status').textContent = 'Connection error';
            };
        }
        
        function loadSkinImages() {
            skins.forEach(skin => {
                const img = new Image();
                img.src = skin.imageUrl;
                skinImages[skin.id] = img;
            });
        }
        
        document.querySelectorAll('.control-card').forEach(card => {
            card.addEventListener('click', () => {
                controlMode = card.dataset.mode;
                showScreen('main-menu');
                loadLeaderboard();
            });
        });
        
        document.getElementById('play-btn').addEventListener('click', startGame);
        document.getElementById('menu-shop-btn').addEventListener('click', openShop);
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('respawn-btn').addEventListener('click', respawn);
        document.getElementById('menu-btn').addEventListener('click', returnToMenu);
        document.getElementById('close-shop').addEventListener('click', closeShop);
        
        function openShop() {
            document.getElementById('shop-points').textContent = playerData.points;
            const grid = document.getElementById('skins-grid');
            grid.innerHTML = '';
            
            skins.forEach(skin => {
                const card = document.createElement('div');
                card.className = 'skin-card';
                const owned = playerData.ownedSkins.includes(skin.id);
                const selected = currentSkinId === skin.id;
                
                if (owned) card.classList.add('owned');
                if (selected) card.classList.add('selected');
                
                card.innerHTML = `
                    <div class="skin-preview">
                        <img src="${skin.imageUrl}" alt="${skin.name}">
                    </div>
                    <h4>${skin.name}</h4>
                    <p style="color: #ffaa00; margin: 8px 0;">${skin.price} Points</p>
                    ${owned ? 
                        (selected ? 
                            '<button class="select" disabled>SELECTED</button>' : 
                            '<button class="select" onclick="selectSkin(\'' + skin.id + '\')">SELECT</button>') :
                        '<button onclick="buySkin(\'' + skin.id + '\')" ' + 
                        (playerData.points >= skin.price ? '' : 'disabled') + 
                        '>BUY</button>'}
                `;
                
                grid.appendChild(card);
            });
            
            document.getElementById('shop-panel').style.display = 'block';
        }
        
        function closeShop() {
            document.getElementById('shop-panel').style.display = 'none';
        }
        
        window.buySkin = function(skinId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'buySkin', skinId }));
            }
        };
        
        window.selectSkin = function(skinId) {
            currentSkinId = skinId;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'selectSkin', skinId }));
            }
            openShop();
        };
        
        function loadLeaderboard() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'getLeaderboard' }));
            }
        }
        
        function startGame() {
            showScreen('game-container');
            isDead = false;
            document.getElementById('death-screen').style.display = 'none';
            document.getElementById('chat-toggle').style.display = 'block';
            
            if (controlMode === 'mobile') {
                document.getElementById('mobile-controls').style.display = 'block';
                document.getElementById('sprint-btn').style.display = 'block';
            }
            
            setupCanvas();
            connectToGame();
            if (!gameLoopRunning) {
                gameLoopRunning = true;
                gameLoop();
            }
        }
        
        function connectToGame() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ 
                    type: 'join', 
                    username: currentUsername,
                    skinId: currentSkinId
                }));
            }
        }
        
        function respawn() {
            isDead = false;
            document.getElementById('death-screen').style.display = 'none';
            connectToGame();
        }
        
        function returnToMenu() {
            showScreen('main-menu');
            isDead = false;
            document.getElementById('death-screen').style.display = 'none';
            document.getElementById('chat-box').style.display = 'none';
            document.getElementById('chat-toggle').style.display = 'none';
            document.getElementById('mobile-controls').style.display = 'none';
            document.getElementById('sprint-btn').style.display = 'none';
            chatUnlocked = false;
            loadLeaderboard();
        }
        
        function logout() {
            if (ws) ws.close();
            showScreen('auth-screen');
            document.getElementById('auth-username').value = '';
            document.getElementById('auth-password').value = '';
            document.getElementById('auth-status').textContent = '';
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('game-container').style.display = 'none';
            
            if (screenId === 'game-container') {
                document.getElementById('game-container').style.display = 'block';
            } else {
                document.getElementById(screenId).style.display = 'flex';
            }
        }
        
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const minimap = document.getElementById('minimap');
        const minimapCtx = minimap.getContext('2d');
        
        function setupCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        window.addEventListener('resize', () => {
            if (document.getElementById('game-container').style.display === 'block') {
                setupCanvas();
            }
        });
        
        // Keyboard controls for WASD and sprint
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            
            if (e.key === 'Shift') {
                isSprinting = true;
            }
            
            if (controlMode === 'wasd' && !isDead) {
                const now = Date.now();
                if (now - lastInputTime > 50) {
                    updateWASDDirection();
                    sendInput();
                    lastInputTime = now;
                }
            }
            
            if (e.key === 'Enter' && chatUnlocked) {
                const input = document.getElementById('chat-input');
                if (document.activeElement === input) {
                    sendChatMessage();
                } else {
                    input.focus();
                }
            }
            
            // Space bar to drop balls
            if (e.key === ' ' && !isDead) {
                e.preventDefault();
                dropBall();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
            
            if (e.key === 'Shift') {
                isSprinting = false;
            }
            
            if (controlMode === 'wasd' && !isDead) {
                updateWASDDirection();
                sendInput();
            }
        });
        
        function updateWASDDirection() {
            let dx = 0, dy = 0;
            if (keys['w']) dy -= 1;
            if (keys['s']) dy += 1;
            if (keys['a']) dx -= 1;
            if (keys['d']) dx += 1;
            
            if (dx !== 0 || dy !== 0) {
                const len = Math.sqrt(dx * dx + dy * dy);
                direction.x = dx / len;
                direction.y = dy / len;
            }
        }
        
        // Cursor controls
        document.addEventListener('mousemove', (e) => {
            if (controlMode === 'cursor' && !isDead) {
                mouseX = e.clientX;
                mouseY = e.clientY;
                
                const snake = gameState.snakes[playerId];
                if (snake && snake.body.length > 0) {
                    const head = snake.body[0];
                    const worldX = head.x - camera.x + canvas.width / 2;
                    const worldY = head.y - camera.y + canvas.height / 2;
                    
                    const dx = mouseX - worldX;
                    const dy = mouseY - worldY;
                    const len = Math.sqrt(dx * dx + dy * dy);
                    
                    if (len > 10) {
                        direction.x = dx / len;
                        direction.y = dy / len;
                        sendInput();
                    }
                }
            }
        });
        
        // Mobile joystick
        const joystick = document.getElementById('joystick');
        const joystickHandle = document.getElementById('joystick-handle');
        
        joystick.addEventListener('touchstart', handleJoystickStart);
        joystick.addEventListener('touchmove', handleJoystickMove);
        joystick.addEventListener('touchend', handleJoystickEnd);
        
        function handleJoystickStart(e) {
            e.preventDefault();
            joystickActive = true;
        }
        
        function handleJoystickMove(e) {
            if (!joystickActive || isDead) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const maxDist = 37.5;
            
            if (dist > maxDist) {
                dx = (dx / dist) * maxDist;
                dy = (dy / dist) * maxDist;
            }
            
            joystickHandle.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            
            if (dist > 5) {
                direction.x = dx / maxDist;
                direction.y = dy / maxDist;
                sendInput();
            }
        }
        
        function handleJoystickEnd() {
            joystickActive = false;
            joystickHandle.style.transform = 'translate(-50%, -50%)';
        }
        
        // Sprint button for mobile
        const sprintBtn = document.getElementById('sprint-btn');
        sprintBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isSprinting = true;
        });
        sprintBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            isSprinting = false;
        });
        
        // Drop ball function
        function dropBall() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'dropBall' }));
            }
        }
        
        function sendInput() {
            if (ws && ws.readyState === WebSocket.OPEN && !isDead) {
                ws.send(JSON.stringify({
                    type: 'input',
                    direction: direction,
                    sprinting: isSprinting
                }));
            }
        }
        
        // WebSocket message handling
        if (ws) {
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                
                switch (msg.type) {
                    case 'init':
                        playerId = msg.id;
                        gameState = msg.gameState;
                        break;
                    case 'update':
                        gameState = msg.gameState;
                        updateHUD();
                        break;
                    case 'death':
                        handleDeath(msg);
                        break;
                    case 'chat':
                        addChatMessage(msg.username, msg.message);
                        break;
                    case 'chatUnlocked':
                        chatUnlocked = true;
                        break;
                    case 'leaderboard':
                        displayLeaderboard(msg.leaders);
                        break;
                    case 'skinPurchased':
                        playerData = msg.playerData;
                        openShop();
                        break;
                }
            };
        }
        
        function handleDeath(msg) {
            isDead = true;
            document.getElementById('death-score').textContent = msg.score;
            document.getElementById('death-points').textContent = msg.pointsEarned;
            document.getElementById('death-total').textContent = msg.totalPoints;
            document.getElementById('death-high').textContent = msg.highScore;
            document.getElementById('death-screen').style.display = 'block';
            playerData.points = msg.totalPoints;
            playerData.highScore = msg.highScore;
        }
        
        function updateHUD() {
            const snake = gameState.snakes[playerId];
            if (snake) {
                document.getElementById('score').textContent = snake.score;
                document.getElementById('points').textContent = playerData.points;
                document.getElementById('highscore').textContent = playerData.highScore;
            }
            
            const playersContainer = document.getElementById('players-container');
            playersContainer.innerHTML = '';
            const sortedSnakes = Object.values(gameState.snakes).sort((a, b) => b.score - a.score);
            sortedSnakes.forEach(snake => {
                const item = document.createElement('div');
                item.className = 'player-item';
                item.innerHTML = `<span>${snake.username}</span><span>${snake.score}</span>`;
                playersContainer.appendChild(item);
            });
        }
        
        function displayLeaderboard(leaders) {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            leaders.forEach((leader, i) => {
                const item = document.createElement('div');
                item.className = 'leader-item';
                if (i === 0) item.classList.add('top1');
                else if (i === 1) item.classList.add('top2');
                else if (i === 2) item.classList.add('top3');
                item.innerHTML = `<span>${i + 1}. ${leader.username}</span><span>${leader.highScore}</span>`;
                list.appendChild(item);
            });
        }
        
        // Chat
        document.getElementById('chat-toggle').addEventListener('click', () => {
            const chatBox = document.getElementById('chat-box');
            chatBox.style.display = chatBox.style.display === 'none' ? 'block' : 'none';
        });
        
        document.getElementById('chat-send').addEventListener('click', sendChatMessage);
        
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'chat', message }));
                input.value = '';
            }
        }
        
        function addChatMessage(username, message) {
            const container = document.getElementById('chat-messages');
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-msg';
            msgEl.innerHTML = `<span class="user">${username}:</span> ${message}`;
            container.appendChild(msgEl);
            container.scrollTop = container.scrollHeight;
        }
        
        // Game rendering
        function gameLoop() {
            if (!isDead) {
                render();
                renderMinimap();
            }
            requestAnimationFrame(gameLoop);
        }
        
        function render() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const snake = gameState.snakes[playerId];
            if (snake && snake.body.length > 0) {
                camera.x = snake.body[0].x;
                camera.y = snake.body[0].y;
            }
            
            ctx.save();
            ctx.translate(-camera.x + canvas.width / 2, -camera.y + canvas.height / 2);
            
            // Draw grid
            ctx.strokeStyle = 'rgba(0,255,136,0.1)';
            ctx.lineWidth = 1;
            const gridSize = 50;
            const startX = Math.floor((camera.x - canvas.width / 2) / gridSize) * gridSize;
            const startY = Math.floor((camera.y - canvas.height / 2) / gridSize) * gridSize;
            
            for (let x = startX; x < camera.x + canvas.width / 2; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, camera.y - canvas.height / 2);
                ctx.lineTo(x, camera.y + canvas.height / 2);
                ctx.stroke();
            }
            for (let y = startY; y < camera.y + canvas.height / 2; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(camera.x - canvas.width / 2, y);
                ctx.lineTo(camera.x + canvas.width / 2, y);
                ctx.stroke();
            }
            
            // Draw world bounds
            ctx.strokeStyle = '#ff0055';
            ctx.lineWidth = 5;
            ctx.strokeRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
            
            // Draw balls
            gameState.balls.forEach(ball => {
                ctx.fillStyle = ball.color;
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Draw snakes
            Object.values(gameState.snakes).forEach(snake => {
                snake.body.forEach((segment, i) => {
                    const img = skinImages[snake.skinId];
                    if (img && img.complete) {
                        ctx.save();
                        ctx.translate(segment.x, segment.y);
                        ctx.drawImage(img, -segment.radius, -segment.radius, segment.radius * 2, segment.radius * 2);
                        ctx.restore();
                    } else {
                        ctx.fillStyle = i === 0 ? '#00ff88' : '#00cc66';
                        ctx.beginPath();
                        ctx.arc(segment.x, segment.y, segment.radius, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
                
                // Draw username
                if (snake.body.length > 0) {
                    const head = snake.body[0];
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 14px Orbitron';
                    ctx.textAlign = 'center';
                    ctx.fillText(snake.username, head.x, head.y - head.radius - 10);
                }
            });
            
            ctx.restore();
        }
        
        function renderMinimap() {
            minimapCtx.fillStyle = 'rgba(0,0,0,0.8)';
            minimapCtx.fillRect(0, 0, minimap.width, minimap.height);
            
            const scaleX = minimap.width / WORLD_WIDTH;
            const scaleY = minimap.height / WORLD_HEIGHT;
            
            // Draw world bounds
            minimapCtx.strokeStyle = '#00ff88';
            minimapCtx.lineWidth = 2;
            minimapCtx.strokeRect(0, 0, minimap.width, minimap.height);
            
            // Draw snakes
            Object.values(gameState.snakes).forEach(snake => {
                if (snake.body.length > 0) {
                    const head = snake.body[0];
                    minimapCtx.fillStyle = snake.id === playerId ? '#00ffff' : '#ff00ff';
                    minimapCtx.beginPath();
                    minimapCtx.arc(head.x * scaleX, head.y * scaleY, 3, 0, Math.PI * 2);
                    minimapCtx.fill();
                }
            });
        }
    </script>
</body>
</html>
