<!DOCTYPE html>
<html>
<head>
<title>Tic Tac Toe</title>
<style>
body{font-family:sans-serif;text-align:center;margin-top:50px;}
table{margin:auto;border-collapse:collapse;}
td{width:80px;height:80px;font-size:50px;border:1px solid #333;cursor:pointer;text-align:center;}
#status{margin-top:20px;font-size:20px;}
</style>
</head>
<body>
<h1>Tic Tac Toe</h1>
<div id="status">Connecting...</div>
<table id="board">
<tr><td data-x="0" data-y="0"></td><td data-x="1" data-y="0"></td><td data-x="2" data-y="0"></td></tr>
<tr><td data-x="0" data-y="1"></td><td data-x="1" data-y="1"></td><td data-x="2" data-y="1"></td></tr>
<tr><td data-x="0" data-y="2"></td><td data-x="1" data-y="2"></td><td data-x="2" data-y="2"></td></tr>
</table>

<script>
let ws = new WebSocket(`ws://${location.host}/ws`);
let mySymbol = '';
let boardEl = document.getElementById("board");
let statusEl = document.getElementById("status");

ws.onmessage = e => {
    let msg = JSON.parse(e.data);
    if(msg.action=="waiting"){
        statusEl.innerText = "Waiting for opponent...";
    } else if(msg.action=="start"){
        statusEl.innerText = "Game started!";
        updateBoard(msg.board);
        mySymbol = "X"; // first player is always X
    } else if(msg.action=="board"){
        updateBoard(msg.board);
        if(msg.last_move.symbol != mySymbol){
            statusEl.innerText = "Your turn!";
        } else {
            statusEl.innerText = "Opponent's turn";
        }
    } else if(msg.action=="winner"){
        statusEl.innerText = msg.winner==mySymbol?"You win!":"You lose!";
    } else if(msg.action=="draw"){
        statusEl.innerText = "Draw!";
    } else if(msg.action=="error"){
        alert(msg.msg);
    }
};

function updateBoard(board){
    for(let y=0;y<3;y++){
        for(let x=0;x<3;x++){
            boardEl.rows[y].cells[x].innerText = board[y][x];
        }
    }
}

boardEl.addEventListener("click", e=>{
    if(e.target.tagName!="TD") return;
    let x=parseInt(e.target.dataset.x);
    let y=parseInt(e.target.dataset.y);
    ws.send(JSON.stringify({action:"move",x:x,y:y}));
});
</script>
</body>
</html>
