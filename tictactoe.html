<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tic Tac Toe</title>
<style>
    body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 50px; }
    #status { margin-bottom: 20px; font-size: 18px; }
    #board { display: grid; grid-template-columns: repeat(3, 100px); grid-gap: 5px; }
    .cell { width: 100px; height: 100px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 48px; cursor: pointer; }
    .cell.disabled { background: #ddd; cursor: default; }
</style>
</head>
<body>
<h1>Tic Tac Toe</h1>
<div id="status">Connecting...</div>
<div id="board"></div>

<script>
let ws;
let board = [];
let mySymbol = "";
let myTurn = false;

function renderBoard() {
    const boardDiv = document.getElementById("board");
    boardDiv.innerHTML = "";
    for (let y = 0; y < 3; y++) {
        for (let x = 0; x < 3; x++) {
            const cell = document.createElement("div");
            cell.classList.add("cell");
            cell.textContent = board[y][x];
            if (!cell.textContent && myTurn) {
                cell.addEventListener("click", () => makeMove(x, y));
            } else {
                cell.classList.add("disabled");
            }
            boardDiv.appendChild(cell);
        }
    }
}

function makeMove(x, y) {
    ws.send(JSON.stringify({action: "move", x, y}));
}

function connect() {
    ws = new WebSocket(`ws://${window.location.hostname}:8000/ws`);

    ws.onopen = () => {
        document.getElementById("status").textContent = "Connected. Waiting for opponent...";
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.status === "waiting") {
            document.getElementById("status").textContent = data.message;
        }
        else if (data.status === "timeout") {
            document.getElementById("status").textContent = data.message;
        }
        else if (data.status === "start") {
            document.getElementById("status").textContent = "Opponent joined! Game starting...";
            board = data.board;
            mySymbol = "X"; // First player is X
            myTurn = true;
            renderBoard();
        }
        else if (data.action === "board") {
            board = data.board;
            const last = data.last_move;
            if (last.symbol !== mySymbol) {
                myTurn = true;
                document.getElementById("status").textContent = "Your turn!";
            } else {
                myTurn = false;
                document.getElementById("status").textContent = "Opponent's turn...";
            }
            renderBoard();
        }
        else if (data.action === "winner") {
            document.getElementById("status").textContent = data.winner === mySymbol ? "You won!" : "You lost!";
            myTurn = false;
            renderBoard();
        }
        else if (data.action === "draw") {
            document.getElementById("status").textContent = "Draw!";
            myTurn = false;
            renderBoard();
        }
    };

    ws.onclose = () => {
        document.getElementById("status").textContent = "Disconnected.";
    };
}

connect();
</script>
</body>
</html>
