<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tic Tac Toe</title>
<style>
  body { font-family: Arial; text-align: center; background: #f0f0f0; }
  h1 { margin-top: 20px; }
  #status { margin: 10px; font-weight: bold; }
  #board { display: grid; grid-template-columns: repeat(3, 100px); grid-gap: 5px; margin: 20px auto; }
  .cell { width: 100px; height: 100px; background: white; display: flex; justify-content: center; align-items: center; font-size: 2rem; cursor: pointer; border: 2px solid #333; }
  .cell.taken { cursor: default; }
</style>
</head>
<body>

<h1>Tic Tac Toe</h1>
<div id="status">Connecting...</div>
<div id="board"></div>
<button id="restart" style="display:none;">Restart Game</button>

<script>
const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");
const restartBtn = document.getElementById("restart");

// Replace with your FastAPI server URL (ngrok or local)
const ws = new WebSocket("wss://YOUR_NGROK_URL/ws");

let playerSymbol = "";
let myTurn = false;
let gameBoard = ["","","","","","","","",""];

ws.onopen = () => {
  statusEl.textContent = "Connected! Waiting for a game...";
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if(data.type === "player_id") {
    console.log("Your ID:", data.id);
  }
  if(data.type === "status") {
    statusEl.textContent = data.message;
  }
  if(data.type === "start") {
    playerSymbol = data.symbol;
    myTurn = (playerSymbol === "X");
    statusEl.textContent = myTurn ? "Your turn!" : "Opponent's turn";
    createBoard();
  }
  if(data.type === "board") {
    gameBoard = data.board;
    updateBoard();
    const winner = checkWinner();
    if(winner) {
      statusEl.textContent = winner === playerSymbol ? "You win!" : "You lose!";
      myTurn = false;
      restartBtn.style.display = "inline";
    } else {
      myTurn = (data.board.filter(c => c==="").length % 2 === (playerSymbol==="X" ? 0 : 1));
      statusEl.textContent = myTurn ? "Your turn!" : "Opponent's turn";
    }
  }
};

// Create clickable cells
function createBoard() {
  boardEl.innerHTML = "";
  gameBoard.forEach((val,i)=>{
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.dataset.index = i;
    cell.textContent = val;
    cell.onclick = () => makeMove(i);
    boardEl.appendChild(cell);
  });
}

function updateBoard() {
  document.querySelectorAll(".cell").forEach((cell,i)=>{
    cell.textContent = gameBoard[i];
    if(gameBoard[i] !== "") cell.classList.add("taken");
  });
}

function makeMove(index) {
  if(!myTurn || gameBoard[index] !== "") return;
  ws.send(JSON.stringify({action:"move", pos:index}));
}

function checkWinner() {
  const combos = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];
  for(let c of combos){
    if(gameBoard[c[0]] && gameBoard[c[0]]===gameBoard[c[1]] && gameBoard[c[1]]===gameBoard[c[2]]){
      return gameBoard[c[0]];
    }
  }
  if(!gameBoard.includes("")) return "draw";
  return null;
}

restartBtn.onclick = () => location.reload();

</script>
</body>
</html>
