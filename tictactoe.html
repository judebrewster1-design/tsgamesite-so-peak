<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Online Tic Tac Toe</title>
<style>
body{
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:#f0f4f8;
  text-align:center;
  margin:0;
  padding:0;
}
header{
  background:#1a73e8;
  color:white;
  padding:20px;
  font-size:24px;
}
#login, #game{
  margin-top:30px;
}
#login input, #login button{
  padding:10px;
  font-size:16px;
  margin:5px;
}
#error{
  color:red;
  font-weight:bold;
}
#warning{
  color:#b71c1c;
  font-size:14px;
  margin-top:10px;
}
#board{
  display:grid;
  grid-template-columns:repeat(3,100px);
  gap:5px;
  margin:20px auto;
}
.cell{
  width:100px;height:100px;
  font-size:48px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:2px solid #1a73e8;
  background:white;
  cursor:pointer;
  transition:0.2s;
}
.cell:hover{
  background:#e3f2fd;
}
#chat-container{
  width:320px;
  margin:20px auto;
  text-align:left;
}
#chat{
  border:1px solid #333;
  width:100%;
  height:200px;
  overflow-y:auto;
  padding:5px;
  background:white;
}
#message{
  width:240px;
  padding:5px;
}
#send-msg{
  padding:6px 12px;
}
</style>
</head>
<body>

<header>Online Tic Tac Toe</header>

<div id="login">
  <h2>Create Username</h2>
  <input type="text" id="username-input" placeholder="Enter your username">
  <button id="login-btn">Join Game</button>
  <p id="error"></p>
  <p id="warning">⚠️ Users can be banned for inappropriate usernames. Please use respectful names.</p>
</div>

<div id="game" style="display:none;">
  <h2 id="welcome"></h2>
  <div id="board"></div>
  <div id="chat-container">
    <h3>Chat</h3>
    <div id="chat"></div>
    <input type="text" id="message" placeholder="Type message">
    <button id="send-msg">Send</button>
  </div>
</div>

<script>
const serverURL = "http://localhost:8000"; // Replace with your server URL
let ws;
let username;

// Local banned storage
function banUser(name){
  let banned = JSON.parse(localStorage.getItem('bannedUsers')||'[]');
  if(!banned.includes(name)) banned.push(name);
  localStorage.setItem('bannedUsers', JSON.stringify(banned));
}

function isLocallyBanned(name){
  const banned = JSON.parse(localStorage.getItem('bannedUsers')||'[]');
  return banned.includes(name);
}

// Server banned check
async function checkServerUsername(name){
  try{
    const res = await fetch(`${serverURL}/check_username?username=${encodeURIComponent(name)}`);
    const data = await res.json();
    return data.allowed;
  }catch(e){
    console.error("Server error", e);
    return false;
  }
}

// Login
document.getElementById('login-btn').addEventListener('click', async ()=>{
  let name = document.getElementById('username-input').value.trim();
  if(!name){document.getElementById('error').textContent="Enter a username."; return;}
  if(isLocallyBanned(name)){document.getElementById('error').textContent="This username is banned!"; return;}
  const allowed = await checkServerUsername(name);
  if(!allowed){banUser(name); document.getElementById('error').textContent="This username is banned for inappropriate language!"; return;}
  username = name;
  document.getElementById('login').style.display='none';
  document.getElementById('game').style.display='block';
  document.getElementById('welcome').textContent=`Welcome, ${username}`;
  startWebSocket();
});

// WebSocket
function startWebSocket(){
  ws = new WebSocket(`${serverURL.replace("http","ws")}/ws`);
  ws.onmessage = (event)=>{
    const data = JSON.parse(event.data);
    if(data.type==="chat"){
      const chat = document.getElementById('chat');
      chat.innerHTML += `<p><b>${data.username}:</b> ${data.message}</p>`;
      chat.scrollTop = chat.scrollHeight;
    } else if(data.type==="move"){
      const cell = document.querySelector(`#cell-${data.index}`);
      if(cell) cell.textContent = data.symbol;
    }
  }
}

// Board
const boardDiv = document.getElementById('board');
for(let i=0;i<9;i++){
  const div = document.createElement('div');
  div.className='cell';
  div.id = `cell-${i}`;
  div.addEventListener('click',()=>{
    const symbol = "X"; // Simplified: all moves X (expand later for 2-player)
    ws.send(JSON.stringify({type:"move",index:i,symbol:symbol,username:username}));
  });
  boardDiv.appendChild(div);
}

// Chat
document.getElementById('send-msg').addEventListener('click',()=>{
  const msgInput = document.getElementById('message');
  const message = msgInput.value.trim();
  if(message==="") return;
  ws.send(JSON.stringify({type:"chat",username:username,message:message}));
  msgInput.value="";
});
</script>

</body>
</html>
