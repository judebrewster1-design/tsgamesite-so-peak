<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tic Tac Toe Online</title>
<style>
  body { font-family: sans-serif; text-align: center; }
  #board { display: grid; grid-template-columns: repeat(3, 100px); gap: 5px; margin: 20px auto; }
  .cell { width: 100px; height: 100px; font-size: 48px; display: flex; align-items: center; justify-content: center; border: 1px solid #333; cursor: pointer; }
  .cell.disabled { pointer-events: none; background: #eee; }
  #status { margin-top: 20px; font-size: 18px; }
</style>
</head>
<body>
<h1>Tic Tac Toe</h1>
<p>Enter a room name to play:</p>
<input type="text" id="room" placeholder="Room ID">
<button onclick="connect()">Join Room</button>

<div id="board"></div>
<div id="status"></div>

<script>
let ws;
let playerSymbol;
let board = [["","",""],["","",""],["","",""]];
let myTurn = false;

function createBoard() {
    const boardDiv = document.getElementById('board');
    boardDiv.innerHTML = '';
    for(let y=0; y<3; y++){
        for(let x=0; x<3; x++){
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.x = x;
            cell.dataset.y = y;
            cell.textContent = board[y][x];
            cell.onclick = () => makeMove(x, y);
            boardDiv.appendChild(cell);
        }
    }
}

function connect() {
    const room = document.getElementById('room').value.trim();
    if(!room){ alert("Enter a room ID"); return; }
    ws = new WebSocket(`ws://${location.hostname}:8000/ws/${room}`);
    
    ws.onopen = () => {
        document.getElementById('status').textContent = "Connected. Waiting for opponent...";
    }

    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if(data.error){ alert(data.error); return; }
        if(data.action === "board"){
            board = data.board;
            createBoard();
            if(!playerSymbol){
                playerSymbol = (data.board.flat().filter(c=>c!=="").length % 2 === 0) ? "X" : "O";
                myTurn = playerSymbol === "X";
                updateStatus();
            }
        }
        if(data.action === "winner"){
            document.getElementById('status').textContent = "Winner: " + data.winner;
            disableBoard();
        }
        if(data.action === "draw"){
            document.getElementById('status').textContent = "Draw!";
            disableBoard();
        }
        if(data.last_move){
            board[data.last_move.y][data.last_move.x] = data.last_move.symbol;
            createBoard();
            myTurn = (data.last_move.symbol !== playerSymbol);
            updateStatus();
        }
    }

    ws.onclose = () => {
        document.getElementById('status').textContent = "Disconnected.";
        disableBoard();
    }
}

function makeMove(x, y) {
    if(!myTurn || board[y][x] !== "") return;
    ws.send(JSON.stringify({action:"move", x:x, y:y}));
}

function updateStatus() {
    document.getElementById('status').textContent = myTurn ? "Your turn ("+playerSymbol+")" : "Opponent's turn";
}

function disableBoard() {
    document.querySelectorAll('.cell').forEach(c => c.classList.add('disabled'));
}

createBoard();
</script>
</body>
</html>
